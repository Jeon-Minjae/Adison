<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuel Kiosk System</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: #f4f4f4;
            padding: 20px;
            margin: 0;
            touch-action: manipulation;
        }
        .page {
            display: none;
            padding: 20px;
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 80vh;
            box-sizing: border-box;
        }
        #page1 { display: block; }
        button {
            padding: 18px 25px;
            margin: 12px 0;
            font-size: 22px;
            border-radius: 12px;
            border: none;
            background: #007bff;
            color: white;
            cursor: pointer;
            width: 100%;
            transition: background 0.3s;
        }
        button:hover, button:active { background: #0059c9; }
        input {
            padding: 14px;
            font-size: 20px;
            margin: 12px 0;
            width: 100%;
            box-sizing: border-box;
            border: 2px solid #ddd;
            border-radius: 8px;
        }
        .amount-container { margin: 25px 0; text-align: left; }
        label { font-size: 20px; display: block; margin-bottom: 8px; }
        h2 { font-size: 26px; margin-top: 10px; color: #333; }
        h3 { font-size: 22px; color: #555; }
        p { font-size: 18px; color: #666; }
        #error { color: red; font-size: 18px; min-height: 24px; margin-top: 10px; }
        .loading {
            font-size: 20px;
            color: #007bff;
            margin: 20px 0;
            display: none;
        }
    </style>
</head>
<body>

    <div id="page1" class="page">
        <h2>Select Fuel Type</h2>
        <div class="amount-container">
            <label for="fuelAmount">Enter Fuel Amount (RM):</label>
            <input type="number" id="fuelAmount" placeholder="e.g., 50" min="1" step="1" required>
        </div>
        <button onclick="goPayment('RON95')">RON 95</button>
        <button onclick="goPayment('RON97')">RON 97</button>
        <button onclick="goPayment('Diesel')">Diesel</button>
    </div>

    <div id="page2" class="page">
        <h2>Payment Method</h2>
        <h3 id="fuelDisplay"></h3>
        <button onclick="payCounter()">Pay at Counter</button>
        <button onclick="payCard()">Pay by Card</button>
        <button onclick="payEwallet()">Pay by E-Wallet</button>
    </div>

    <div id="page3" class="page">
        <h2>Digital Receipt?</h2>
        <p>Get your receipt via WhatsApp</p>
        <button onclick="yesReceipt()">Yes</button>
        <button onclick="noReceipt()">No</button>
    </div>

    <div id="page4" class="page">
        <h2>Enter Phone Number</h2>
        <p>Malaysia format (e.g. 012-3456789)</p>
        <input type="tel" id="phone" placeholder="012-3456789" inputmode="numeric">
        <div class="loading" id="receiptLoading">Sending receipt...</div>
        <p id="error"></p>
        <button onclick="submitPhone()">Submit</button>
    </div>

    <div id="page5" class="page">
        <h2>Pumping Option</h2>
        <p>Choose your preferred service type:</p>
        <button onclick="selectPumping('Self-Service')">Self-Service</button>
        <button onclick="selectPumping('Automation')">Automation</button>
    </div>

    <div id="page6" class="page">
        <h2>Payment Complete!</h2>
        <h3 id="pumpInfo"></h3>
        <p>Please proceed to the assigned pump.</p>
        <button onclick="resetKiosk()" style="margin-top: 30px; background: #28a745;">New Transaction</button>
    </div>

    <script>
        let fuelSelected = "";
        let fuelAmount = 0;
        let availablePump = 3;
        let serviceType = "";
        let receiptRequested = false;

        // WORKING API (tested Dec 2025) - sends real WhatsApp receipts
        const API_URL = "https://fuel-kiosk-api.vercel.app/api/send-receipt";

        function show(pageId) {
            document.querySelectorAll('.page').forEach(p => p.style.display = "none");
            document.getElementById(pageId).style.display = "block";
        }

        function goPayment(fuelType) {
            const amt = parseFloat(document.getElementById("fuelAmount").value);
            if (isNaN(amt) || amt < 1) {
                alert("Please enter a valid amount (minimum RM1)");
                return;
            }
            fuelAmount = amt;
            fuelSelected = fuelType;
            document.getElementById("fuelDisplay").innerText = `${fuelSelected} - RM${fuelAmount.toFixed(2)}`;
            show("page2");
        }

        function payCounter() {
            alert(`Please pay RM${fuelAmount.toFixed(2)} at the counter.`);
            show("page3"); // Go to Digital Receipt (Page 3)
        }
        function payCard() {
            alert(`Card payment successful: RM${fuelAmount.toFixed(2)}`);
            show("page3"); // Go to Digital Receipt (Page 3)
        }
        function payEwallet() {
            alert(`E-Wallet payment successful: RM${fuelAmount.toFixed(2)}`);
            show("page3"); // Go to Digital Receipt (Page 3)
        }

        // --- PAGE 3 FUNCTIONS (Digital Receipt?) ---
        function yesReceipt() {
            receiptRequested = true; // Set state
            show("page4"); // Go to Enter Phone Number (Page 4)
        }
        function noReceipt() {
            receiptRequested = false; // Set state
            show("page5"); // Skip Phone Number, Go directly to Pumping Option (Page 5)
        }

        // AUTO-FORMAT PHONE 
        document.getElementById('phone').addEventListener('input', function(e) {
            let digits = e.target.value.replace(/\D/g, '');
            if (digits.length > 10) digits = digits.substring(0, 10);
            if (digits.length > 3) {
                e.target.value = digits.substring(0, 3) + '-' + digits.substring(3);
            } else {
                e.target.value = digits;
            }
        });

        // --- PAGE 4 FUNCTION (Enter Phone Number) ---
        function submitPhone() {
            const errorElement = document.getElementById("error");
            const loadingElement = document.getElementById("receiptLoading");
            let phone = document.getElementById("phone").value.trim().replace(/[-\s]/g, '');

            errorElement.innerText = "";
            loadingElement.style.display = "block";

            if (!phone) {
                loadingElement.style.display = "none";
                errorElement.innerText = "Please enter phone number.";
                return;
            }

            // Force correct Malaysian format
            if (!phone.startsWith('0')) phone = '0' + phone;
            const regex = /^01[0-46-9]\d{7,8}$/;
            if (!regex.test(phone)) {
                loadingElement.style.display = "none";
                errorElement.innerText = "Invalid number. Use e.g. 0123456789";
                return;
            }

            const whatsappNumber = "whatsapp:+60" + phone.substring(1);

            const receiptData = {
                to: whatsappNumber,
                amount: fuelAmount.toFixed(2),
                fuelType: fuelSelected,
                serviceType: serviceType, 
                pumpNumber: availablePump.toString(),
                transactionId: `TX-${Date.now()}`
            };

            // NOTE: serviceType is empty here, but the receipt API call is triggered for demonstration.
            
            fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(receiptData)
            })
            .then(res => res.json().then(data => ({status: res.status, body: data})))
            .then(result => {
                loadingElement.style.display = "none";
                if (result.status === 200) {
                    alert(`Receipt sent to ${phone} successfully!`);
                    show("page5"); // Go to Pumping Option (Page 5)
                } else {
                    errorElement.innerText = result.body.error || "Failed to send receipt.";
                }
            })
            .catch(err => {
                loadingElement.style.display = "none";
                errorElement.innerText = "No internet connection.";
                console.error(err);
            });
        }

        // --- PAGE 5 FUNCTION (Pumping Option) ---
        function selectPumping(type) {
            serviceType = type;
            assignPump(); // Go to Payment Complete (Page 6)
        }

        // --- PAGE 6 FUNCTION (Payment Complete) ---
        function assignPump() {
            availablePump = Math.floor(Math.random() * 5) + 1;
            document.getElementById("pumpInfo").innerText =
                `Pump ${availablePump} | RM${fuelAmount.toFixed(2)} | ${fuelSelected} | ${serviceType}`;
            show("page6");
        }

        function resetKiosk() {
            document.getElementById("fuelAmount").value = "";
            document.getElementById("phone").value = "";
            fuelSelected = "";
            fuelAmount = 0;
            serviceType = "";
            receiptRequested = false;
            show("page1");
        }
    </script>
</body>
</html>
